<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Loan Dashboard</title>

    <!-- ✅ Bootstrap + Chart.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ✅ Your Custom Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <style>
        body {
            background: #f7f9fc;
        }

        .tab-content {
            padding: 20px;
        }

        #chatBox {
            height: 250px;
            overflow-y: auto;
            background: #f2f2f2;
            border-radius: 8px;
            padding: 10px;
        }

        #clustersChart {
            height: 350px !important;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <ul class="nav nav-tabs" id="featureTabs">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#predict">Loan Prediction</a>
            </li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#visuals">Visual Insights</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#banks">Bank Suggestion</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#clusters">Customer Clusters</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#chat">AI Chatbot</a></li>
        </ul>

        <div class="tab-content mt-3">
            <!-- ===================== LOAN PREDICTION ===================== -->
            <div id="predict" class="tab-pane fade show active">
                <div class="card p-4">
                    <h4>Loan Default Risk Prediction</h4>
                    <form id="predictForm" class="row g-2">
                        <div class="col-md-4"><input type="number" class="form-control" name="Income"
                                placeholder="Income" required></div>
                        <div class="col-md-4"><input type="number" class="form-control" name="LoanAmount"
                                placeholder="Loan Amount" required></div>
                        <div class="col-md-4"><input type="number" class="form-control" name="CreditScore"
                                placeholder="Credit Score" required></div>
                        <div class="col-12"><button class="btn btn-primary mt-3" type="submit">Predict</button></div>
                    </form>
                    <div id="predictResult" class="mt-3"></div>
                </div>
            </div>

            <!-- ===================== VISUALS ===================== -->
            <div id="visuals" class="tab-pane fade">
                <div class="row">
                    <div class="col-md-6"><canvas id="educationChart"></canvas></div>
                    <div class="col-md-6"><canvas id="corrChart"></canvas></div>
                </div>
            </div>

            <!-- ===================== BANK RECOMMENDATION ===================== -->
            <div id="banks" class="tab-pane fade">
                <div class="card p-4">
                    <h4>Recommended Banks</h4>
                    <form id="bankForm" class="row g-2">
                        <div class="col-md-4"><input type="number" name="CreditScore" class="form-control"
                                placeholder="Credit Score" required></div>
                        <div class="col-md-4"><input type="number" name="Income" class="form-control"
                                placeholder="Income" required></div>
                        <div class="col-md-4"><input type="number" name="Age" class="form-control" placeholder="Age"
                                required></div>
                        <div class="col-md-6"><input type="text" name="Education" class="form-control"
                                placeholder="Education"></div>
                        <div class="col-md-6"><input type="text" name="EmploymentType" class="form-control"
                                placeholder="Employment Type"></div>
                        <div class="col-12"><button class="btn btn-success mt-3" type="submit">Find Banks</button></div>
                    </form>
                    <div id="bankResult" class="mt-3"></div>
                </div>
            </div>

            <!-- ===================== CLUSTERS ===================== -->
            <div id="clusters" class="tab-pane fade">
                <div class="card p-4">
                    <h4>Customer Segmentation by Income & Default</h4>
                    <canvas id="clustersChart"></canvas>
                </div>
            </div>

            <!-- ===================== CHATBOT ===================== -->
            <div id="chat" class="tab-pane fade">
                <div class="card p-4">
                    <h4>Ask the AI Advisor (Gemini)</h4>
                    <div id="chatBox"></div>
                    <div class="input-group mt-3">
                        <input type="text" id="chatInput" class="form-control" placeholder="Type your question...">
                        <button id="chatSend" class="btn btn-dark">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            // ============ LOAN PREDICTION ============
            document.getElementById("predictForm").addEventListener("submit", async (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target).entries());
                const res = await fetch("/api/predict", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                const out = await res.json();
                document.getElementById("predictResult").innerHTML = res.ok
                    ? `<div class='alert alert-info'>Risk Probability: ${(out.probability * 100).toFixed(2)}%<br>${out.suggestion}</div>`
                    : `<div class='alert alert-danger'>${out.error}</div>`;
            });

            // ============ VISUALS ============
            async function loadVisuals() {
                try {
                    const res = await fetch("/api/visuals");
                    const data = await res.json();

                    new Chart(document.getElementById("educationChart"), {
                        type: "pie",
                        data: {
                            labels: data.default_by_education.map(d => d.Education),
                            datasets: [{
                                data: data.default_by_education.map(d => d.Default),
                                backgroundColor: ["#007bff", "#28a745", "#ffc107", "#dc3545", "#17a2b8"]
                            }]
                        }
                    });

                    new Chart(document.getElementById("corrChart"), {
                        type: "bar",
                        data: {
                            labels: Object.keys(data.correlations),
                            datasets: [{ label: "Correlation", data: Object.values(data.correlations) }]
                        }
                    });
                } catch (e) { console.error("Visuals load failed:", e); }
            }
            loadVisuals();

            // ============ BANK RECOMMENDATION ============
            document.getElementById("bankForm").addEventListener("submit", async (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target).entries());
                const res = await fetch("/api/recommend_bank", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                const out = await res.json();
                document.getElementById("bankResult").innerHTML = res.ok
                    ? `<pre>${JSON.stringify(out, null, 2)}</pre>`
                    : `<div class='alert alert-warning'>${out.message || out.error}</div>`;
            });

            // ============ CLUSTERS ============
            async function loadClusters() {
                try {
                    const res = await fetch("/api/clusters");
                    if (!res.ok) return;
                    const data = await res.json();
                    const ctx = document.getElementById("clustersChart").getContext("2d");
                    const clusters = [...new Set(data.map(d => d.Cluster))];
                    new Chart(ctx, {
                        type: "scatter",
                        data: {
                            datasets: clusters.map(c => ({
                                label: "Cluster " + c,
                                data: data.filter(d => d.Cluster === c).map(d => ({ x: d.Income, y: d.Default })),
                                pointRadius: 4
                            }))
                        },
                        options: {
                            scales: {
                                x: { title: { display: true, text: "Income" } },
                                y: { title: { display: true, text: "Default" } }
                            }
                        }
                    });
                } catch (e) { console.error("Cluster load failed:", e); }
            }
            loadClusters();

            // ============ CHATBOT ============
            document.getElementById("chatSend").addEventListener("click", async () => {
                const msg = document.getElementById("chatInput").value.trim();
                if (!msg) return;
                const chatBox = document.getElementById("chatBox");
                chatBox.innerHTML += `<div><b>You:</b> ${msg}</div>`;
                document.getElementById("chatInput").value = "";
                const res = await fetch("/api/chat", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: msg })
                });
                const out = await res.json();
                chatBox.innerHTML += `<div><b>Bot:</b> ${out.reply}</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        });
    </script>
</body>

</html>